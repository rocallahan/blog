---
layout: "post"
title: "Update To rr Master To Debug Firefox Trunk"
date: "2019-04-26 08:14:00 +0000"
categories: "Mozilla"
permalink: "/2019/04/update-to-rr-master-to-debug-firefox.html"
---
<p>A few days ago Firefox <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1460811">started using</a> <a href="http://www.lmdb.tech/doc/">LMDB</a> (via <a href="https://github.com/mozilla/rkv">rkv</a>) to store some startup info. LMDB relies on file descriptor I/O being coherent with memory-maps in a way that rr didn't support, so people have had trouble debugging Firefox in rr, and Pernosco's CI test failure reproducer also broke. We have checked in a <a href="https://github.com/mozilla/rr/commit/f1843c474b27517f7f3b6240621f4f4a9e369e96">fix</a> to rr master and are in the process of updating the Pernosco pipeline.
<p>The issue is that LMDB opens a file, maps it into memory <tt>MAP_SHARED</tt>, and then opens the file again and writes to it through the new file descriptor, and requires that the written data be immediately reflected in the shared memory mapping. (This behavior is not guaranteed by POSIX but is guaranteed by Linux.) rr needs to observe these writes and record the necessary memory changes, otherwise they won't happen during replay (because writes to files don't happen during replay) and replay will fail. rr already handled the case when the application write to the file descriptor (technically, the file <em>description</em>) that was used to map the file &mdash; Chromium has needed this for a while. The LMDB case is harder to handle. To fix LMDB, whenever the application opens a file for writing, we have to check to see if any shared mapping of that file exists and if so, mark that file description so writes to it have their shared-memory effects recorded. Unfortunately this adds overhead to writable file opens, but hopefully it doesn't matter much since in many workloads most file opens are read-only. (If it turns out to be a problem there are ways we can optimize further.) While fixing this, we also added support for the case where the application opens a file (possibly multiple times with different file descriptions) and then creates a shared mapping of one of them. To handle that, when creating a shared mapping we have to scan all open files to see if any of them refer to the mapped file, and if so, mark them so the effects of their writes are recorded.
<p><strong>Update</strong> Actually, at least <a href="https://github.com/mozilla/rr/commit/bce17104ff55118b5e774f079843230af5fdaa89">this commit</a> is required.