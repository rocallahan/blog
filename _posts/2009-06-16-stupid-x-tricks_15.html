---
layout: "post"
title: "Stupid X Tricks"
date: "2009-06-15 15:12:00 +0000"
categories: "Mozilla"
permalink: "/2009/06/stupid-x-tricks_15.html"
---
<div class="columns"><p>Platforms like X and Win32 support trees of native windows. For example,<br/>an application might have a "top-level" window containing child windows<br/>representing controls such as buttons. In browsers, child windows are required<br/>for many kinds of plugins (e.g., most uses of Flash). Managing these child<br/>windows is quite tricky; they add performance overhead and the native<br/>platform's support for event handling, z-ordering, clipping, graphical effects,<br/>etc, often is not a good match for the behaviours required for Web content,<br/>especially as the Web platform evolves. So I'm working hard to get rid of<br/>the use of child windows and I've made a lot of progress --- more about that<br/>later. However, we're stuck with using child windows for plugins, and recently<br/>I've been grappling with one of the hardest problems involving child windows:<br/>scrolling.<br/><p>It's very hard to make scrolling smooth in the presence of child windows<br/>for plugins, when all other child windows have been eliminated. In general<br/>you want to scroll (using accelerated blitting) some sub-rectangle of the<br/>document's window (e.g., an overflow:auto element), and some of the plugin<br/>windows will move while others won't. You may want to change the clip region<br/>of some of the plugins to reflect the fact that they're being clipped to the<br/>bounds of the overflow:auto element. The big problem is that to avoid flicker<br/>you want to move the widgets, change their clip regions, and blit the contents<br/>of the scrolled area in one atomic operation. If these things happen<br/>separately the window is likely to display artifacts as it passes through<br/>undesired intermediate states. For example, if you blit the scrolled area<br/>first, then move the plugins, the plugin will appear to slightly lag<br/>behind as you scroll the window.<br/><p>On Windows, <a<br/>href="http://msdn.microsoft.com/en-us/library/bb787593%28VS.85%29.aspx"><br/>ScrollWindowEx</a> with the SW_SCROLLCHILDREN flag gets you a long way. But<br/>on X, the situation is dire. X simply has no API to scroll the contents of a<br/>window including child windows! Toolkits like GTK resort to<br/><abbr title="In Gauntlet II, if your party throws caution to the wind and<br/>charges headlong into a large room full of monsters, is surrounded but<br/>miraculously manages to destroy them all, the game declares<br/>'that was a heroic effort!'. That is the sense in which I use the term<br/>here.">heroic efforts</abbr> such as<br/><a href="https://stage.maemo.org/svn/maemo/projects/haf/trunk/gtk+/gdk/x11/gdkgeometry-x11.c"><br/>guffaw scrolling</a> to achieve the effect, but those techniques don't let<br/>you scroll a sub-rectangle of a window, only the entire window. So for Gecko<br/>I have had to come up with something new.<br/><p>Basically I want to use <a href="http://tronche.com/gui/x/xlib/graphics/XCopyArea.html"><br/>XCopyArea</a> and have it copy the contents of the window *and* the contents<br/>of some of the child windows in the scrolled area, and then move the child<br/>windows into their new locations and change their clip regions (I'm using<br/>XShape for this) without doing any extra repainting. I tried a few things that<br/>didn't work, before I hit a solution:<br/><ol><br/><li>Hide (unmap) all child windows that are going to be moved during the scroll<br/>operation<br/><li>Do the XCopyArea<br/><li>Set the clip region and position of all relevant child windows<br/><li>Show (map) all child windows that we hid in step 1<br/></ol><br/><p>By hiding the child windows during the XCopyArea, we trick the X server into<br/>treating the pixels currently on-screen for them as part of the parent window,<br/>so they are copied. By moving and setting the clip region while each child<br/>window is hidden, we also avoid artifacts due to a child window briefly<br/>appearing outside the area it's supposed to be clipped to. It *does* mean that when we scroll a window containing plugins, expose events are generated to repaint the contents of the plugins' child windows, so scrolling is slower than it could be. We might be able to avoid that by enabling backing store for the plugin windows.<br/><p>It's somewhat tricky to implement this. We have to compute the desired<br/>child window locations and clip regions, store the results in a collection,<br/>and pass that collection into our platform window abstraction's Scroll() API<br/>so that the scrolling and widget configuration can happen as a unified<br/>operation. But I've done it, and it works great on my Ubuntu VM. I'm not<br/>100% sure that it will work well on all X servers and configurations; that's<br/>something we'll need to get good testing of.<br/><p>I do wonder why X has never felt the need to grow a genuinely useful<br/>scrolling API. Oh well.</div><br/><br/>
<div class='comments'><h2>Comments</h2>
<div class='comment'>
<div class='author'>Neil Rashbrook</div>
<div class='content'>Hey, it took Microsoft several releases before it grew a usable window scrolling function ;-)<br></div>
</div>
<div class='comment'>
<div class='author'>Robert O'Callahan</div>
<div class='content'>Neil, Windows and X are about the same age. Windows got ScrollWindowEx about 15 years ago.<br></div>
</div>
<div class='comment'>
<div class='author'>Ian M</div>
<div class='content'>Why don&#39;t you contribute code to X.org, rather than complain about it and hack around it?<br>The X.org developers aren&#39;t going to know what functionality you need if you don&#39;t tell them.<br></div>
</div>
<div class='comment'>
<div class='author'>Wladimir Palant</div>
<div class='content'>&gt; However, we&#39;re stuck with using child windows for plugins<br>Sorry to hear that. I remember that you had some ideas for fixing that a few years back, letting plugins render into an invisible window and translating incoming events for them. That would solve lots of problems. But I guess that&#39;s off the table?<br></div>
</div>
<div class='comment'>
<div class='author'>Robert O'Callahan</div>
<div class='content'>&gt; I remember that you had some ideas for fixing<br>&gt; that a few years back, letting plugins render<br>&gt; into an invisible window and translating incoming<br>&gt; events for them.<br>We actually have that on trunk, Jeff Muzielaar did it for Fennec&#39;s usage, but it&#39;s a performance hit for plugin rendering.<br>&gt; There might also be something in the flags you<br>&gt; pass to XCopyArea that suppress expose events.<br>That won&#39;t help, the expose events are generated by the map/unmap pair.<br>&gt; Why don&#39;t you contribute code to X.org, rather<br>&gt; than complain about it and hack around it?<br>Why didn&#39;t the GTK2 developers get the X developers to fix it? They&#39;ve been hacking around it for several years longer than I have. In some cases they&#39;re even the same people. At least I can assume X developers have heard about the problem.<br>Also, one of the reasons contributing to X is not appealing in general is that it takes years for new X servers to be deployed.. In the mean time we have to hack around the problems anyway. So why should I do twice the work? (More than twice actually, sine we don&#39;t have any experienced X developers on staff.)<br></div>
</div>
<div class='comment'>
<div class='author'>Michael V</div>
<div class='content'>&quot;It *does* mean that when we scroll a window containing plugins, expose events are generated to repaint the contents of the plugins&#39; child windows, so scrolling is slower than it could be. We might be able to avoid that by enabling backing store for the plugin windows.&quot;<br>Almost no X server out there supports backing store AFAICT. I think using a composited window manager causes expose events to be sent far less often, but I&#39;m not sure. There might also be something in the flags you pass to XCopyArea that suppress expose events.<br></div>
</div>
<div class='comment'>
<div class='author'>Arpad Borsos</div>
<div class='content'>I believe the motivation behind the &quot;client-side-windows&quot; branch of gtk+ is the same. Having gtk+ manage the widgets itself instead of making every widget a X subwindow.<br>I&#39;m glad there is progress.<br></div>
</div>
<div class='comment'>
<div class='author'>Mardeg</div>
<div class='content'>Mark Finkle just mentioned they had to back out some CSS-as-UI-theme changes due to poor performance on box-shadow with panning.. would that be improved by this?<br>http://starkravingfinkle.org/blog/2009/06/fennec-performance-is-the-theme/<br></div>
</div>

</div>