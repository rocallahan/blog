---
layout: "post"
title: "Ordered Maps For Stable Rust"
date: "2016-07-07 06:16:00 +0000"
categories: "Mozilla"
permalink: "/2016/07/ordered-maps-for-stable-rust.html"
---
<p>The canonical ordered-map type for Rust is <a href="https://doc.rust-lang.org/std/collections/struct.BTreeMap.html"><tt>std::collections::BTreeMap</tt></a>, which looks nice, except that the <a href="https://doc.rust-lang.org/std/collections/struct.BTreeMap.html#method.range">range</a> methods are marked unstable and so can't be used at all except with the nightly-build Rust toolchain. Those methods are the only way to perform operations like "find first element greater than a given key", so <tt>BTreeMap</tt> is mostly useless in stable Rust.
<p>This wouldn't be a big deal if <a href="https://crates.io">crates.io</a> had a good ordered-map library that worked with stable Rust ... but, as far as I can tell, until now it did not. I didn't want to switch to Rust nightly just to use ordered maps, so I solved this problem by forking container-rs's <a href="https://crates.io/crates/bst"><tt>bst</tt></a> crate, modifying it to work on stable Rust (which meant ripping out a bunch of "unstable" annotations, fixing a few places that required unstable "box" syntax, and fixing some test code that depended on unboxed closures), and publishing the result as <a href="https://crates.io/crates/stable_bst"><tt>stable_bst</tt></a>. (Note: I haven't actually gotten around to using it yet, so maybe it's broken, but at least its tests pass.)
<p>So, if you want to use ordered maps with stable Rust, give it a try. <tt>bst</tt> has a relatively simple implementation and, no doubt, is less efficient than <tt>BTreeMap</tt>, but it should be comparable to the usual C++ <tt>std::map</tt> implementations.
<p>Currently it supports only C++-style <tt>lower_bound</tt> and <tt>upper_bound</tt> methods for finding elements less/greater than a given key. <tt>range</tt> methods similar to <tt>BTreeMap</tt> could easily be added, using a local copy of the unstable standard <tt>Bound</tt> type. I'm not sure if I'll bother but I'd accept PRs.
<p><strong>Update</strong> I realized the <tt>lower_bound</tt> and <tt>upper_bound</tt> methods were somewhat useless since they only return forward iterators, so I bit the bullet, implemented the <tt>range</tt>/<tt>range_mut</tt> methods, removed <tt>lower_bound</tt>/<tt>upper_bound</tt> and the reverse iterators which are superseded by <tt>range</tt>, and updated <a href="https://crates.io/crates/stable_bst">crates.io</tt></a>.
<p>FWIW I really like the <tt>range</tt> API compared to C++-style <tt>upper/lower_bound</tt>. I always have to think carefully to use the C++ API correctly, whereas the <tt>range</tt> API is easy to use correctly: you specify upper and lower bounds, each of which can be unbounded, exclusive or inclusive, just like in mathematics. A nice feature of the <tt>range</tt> API (when implemented correctly!) is that if you happen to specify a lower bound greater than the upper bound, it returns an empty iterator, instead of returning some number of wrong elements --- or crashing exploitably --- as the obvious encoding in C++ would do.
<p>Another somewhat obscure but cool feature of <tt>range</tt> is that the values for bounds don't have to be exactly the same type as the keys, if you set up traits correctly. ogoodman on <a href="https://github.com/rust-lang/rust/issues/27787#issuecomment-230145044">github</a> pointed out that in some obscure cases you want range endpoints that can't be expressed as key values. Their example is keys of type (A, B), lexicographically ordered, where B does not have min or max values (e.g., arbitrary-precision integers), and you want a range containing all keys with a specific value for A. With the BTreeMap and stable_bst::TreeMap APIs you can handle this by making the bounds be type B', where B' is B extended with artificial min/max values, and defining traits to order B/B' values appropriately.
<div class='comments'><h2>Comments</h2>
<div class='comment'>
<div class='author'>Oliver Goodman</div>
<div class='content'>Nice one Robert! Thanks for the tip about the range bounds not needing to be in the (same) ordered set. This is a useful stop-gap while the rust team figure out what they need to do to stabilise BTreeMap, and preferable to switching to the nightly build for anyone who wants to get something published.</div>
</div>

</div>