---
layout: "post"
title: "mozLoadFrom And The Media Cache"
date: "2009-09-21 17:22:00 +0000"
categories: "Mozilla"
permalink: "/2009/09/mozloadfrom-and-media-cache_21.html"
---
<div class="columns">In April I wrote about <a href="/2009/04/media_cache.html">the Gecko media cache</a>. Just recently I needed to make a significant extension to the media cache design to support a new experimental &lt;video&gt; element API: <code>mozLoadFrom</code>.<br/><p><code>v1.mozLoadFrom(v2)</code> behaves much like the <code>load</code> method of <code>HTMLMediaElement</code>. It stops playing the currently loaded resource and loads a new resource. However, it does not run the HTML5 media selection algorithm; instead it just takes <code>v2</code>'s <code>currentSrc</code> and loads that. What makes <code>mozLoadFrom</code> useful is that it tries to avoid re-downloading the resource data. It grabs all the cached and buffered data already associated with <code>v2</code> and makes it available to <code>v1</code> as well. In fact these elements carry on sharing data, so that any future data downloaded by <code>v1</code> or <code>v2</code> is available to the other. Typically this means that only one of the elements will actually be downloading data and the other one won't need to download anything at all. (Although if the entire resource doesn't fit in the media cache, you can end up in situations where the elements are playing different points in the stream and both reading from different offsets.)<br/><p><code>mozLoadFrom</code> is useful if you need to manipulate multiple views of the same video/audio stream. For example you might be playing a video and at the same time you want a script to seek forwards or backwards and gather periodic snapshots into a series of &lt;canvas&gt;es. Or you might have a set of videos playing in the page at a smallish size and want to display a selected one in the front covering most of the window, without having to mess with the original thumbnail video. The main reason I implemented <code>mozLoadFrom</code> is to make it easier to display full-screen video in Firefox or extensions.<br/><p>The tricky part of the implementation is that the media cache was originally designed so that a block in the cache could only belong to one decoder at a time. With <code>mozLoadFrom</code> a block can be owned by multiple decoders at a time. In the original design, a block is always in exactly one of four states: free, readahead (it's ahead of the current playback point), played (it's behind the current playback point), and metadata. Now a block can be a readahead block for one decoder and a played block for another decoder.<br/><p>I was quite worried it would be hard to extend the design this way, but in fact I was able to do it in about a day of intense hacking. This probably reflects well on the original design of the media cache. In particular, basing eviction decisions on the "predicted time of next use" was easy to extend; when a block has multiple owners, its predicted time of next use is the earliest time that any of its owners predicts for it.<br/><p><strong>Update</strong> Ian Hickson points out that new API is not needed here since HTML5 <a href="http://www.whatwg.org/specs/web-apps/current-work/#fetch">allows</a> concurrent loads of the same absolute URI to share data regardless of HTTP caching instructions. So instead of <code>mozLoadFrom</code> we could just use <code>v1.src = v2.currentSrc</code> to get the same effect. I should do that...</div><br/><br/>
<div class='comments'><h2>Comments</h2>
<div class='comment'>
<div class='author'>Robert O'Callahan</div>
<div class='content'>Hmm, indeed. I didn&#39;t know that section 2.6 lets us ignore HTTP caching semantics for cases like this. Great!<br></div>
</div>
<div class='comment'>
<div class='author'>Ian Hickson</div>
<div class='content'>Per the HTML5 spec, just creating a new  and doing newvideo.src = firstvideo.currentSrc; should have the same effect. (Well, may have. Implementations aren&#39;t _required_ to use the same streams, but they&#39;re allowed to.)<br></div>
</div>

</div>